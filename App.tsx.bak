import React, { useEffect, useState } from 'react';
import { StatusBar } from 'expo-status-bar';
import { View, ActivityIndicator } from 'react-native';
import { NavigationContainer } from '@react-navigation/native';
import { PersistQueryClientProvider } from '@tanstack/react-query-persist-client';
import * as Linking from 'expo-linking';
import BottomTabNavigator from '@navigation/BottomTabNavigator';
import { ErrorBoundary, OfflineBanner } from '@shared/components/ui';
import { queryClient, persister } from '@api/queryClient';
import { setAuthToken } from '@api/client';

// Reactotron initialization (must be FIRST in dev!)
if (__DEV__) {
  require('./reactotron.config');
}

// Sentry initialization (must be early!)
import { initializeSentry } from './sentry.config';
initializeSentry();

// Services
import { authService } from '@services/auth/authService';
import { socketService } from '@services/socket/socketClient';
import { offlineQueue } from '@services/offline/offlineQueue';
import { notificationService } from '@services/notifications/notificationService';
import { analyticsService } from '@services/analytics/analyticsService';
import { featureFlagsService } from '@services/featureFlags/featureFlagsService';

// Hooks
import { useActivityRealtimeSync } from '@features/activities/hooks/useActivityRealtimeSync';
import { useScreenTracking } from '@shared/hooks/useAnalytics';
import { useNotifications } from '@shared/hooks/useNotifications';

// Set development JWT token for API testing
if (__DEV__) {
  setAuthToken('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfMTIzIiwidHlwZSI6ImFjY2VzcyIsImV4cCI6MTc2Mjk2NTM3M30.oIlENdoxTZ_C0MZnDUsupvsXP6FAce634S9LBWg333U');
  console.log('ðŸ”‘ Dev JWT token set');
}

/**
 * App Component - Root Component with Service Initialization
 *
 * Responsibilities:
 * - Initialize all services
 * - Setup real-time sync
 * - Configure deep linking
 * - Handle notifications
 * - Track analytics
 */
function AppContent() {
  // Enable real-time sync
  useActivityRealtimeSync();

  // Enable screen tracking
  useScreenTracking();

  // Enable notification handling
  useNotifications();

  useEffect(() => {
    // Cleanup on unmount
    return () => {
      socketService.disconnect();
      offlineQueue.stopAutoProcessing();
      analyticsService.cleanup();
      notificationService.cleanup();
      featureFlagsService.cleanup();
    };
  }, []);

  return (
    <>
      <BottomTabNavigator />
      <OfflineBanner />
      <StatusBar style="auto" />
    </>
  );
}

export default function App() {
  const [isInitializing, setIsInitializing] = useState(true);

  useEffect(() => {
    let mounted = true;

    async function initializeApp() {
      try {
        console.log('ðŸš€ Initializing app services...');

        // Initialize services in parallel
        await Promise.all([
          authService.initialize(),
          featureFlagsService.initialize(),
          analyticsService.initialize(),
          notificationService.initialize(),
        ]);

        // Initialize WebSocket (requires auth)
        if (authService.isAuthenticated()) {
          await socketService.connect();
        }

        // Start offline queue auto-processing
        offlineQueue.startAutoProcessing();

        if (mounted) {
          setIsInitializing(false);
          console.log('âœ… App services initialized');
        }
      } catch (error) {
        console.error('âŒ App initialization failed:', error);

        if (mounted) {
          setIsInitializing(false);
        }
      }
    }

    initializeApp();

    return () => {
      mounted = false;
    };
  }, []);

  // Deep linking configuration
  const linking = {
    prefixes: [
      'activityapp://',
      'https://activity.app',
      'https://www.activity.app',
    ],
    config: {
      screens: {
        ActivityScreen: 'activities',
        ActivityDetail: 'activities/:activityId',
        ProfileScreen: 'profile/:userId',
        ChatsScreen: 'chat',
        ChatDetail: 'chat/:chatId',
        MapViewScreen: 'map',
        DiscoverScreen: 'discover',
        NotificationsScreen: 'notifications',
      },
    },
  };

  // Show loading screen while initializing
  if (isInitializing) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>
        <ActivityIndicator size="large" color="#4A90E2" />
      </View>
    );
  }

  return (
    <ErrorBoundary>
      <PersistQueryClientProvider
        client={queryClient}
        persistOptions={{
          persister,
          maxAge: 24 * 60 * 60 * 1000, // 24 hours
          dehydrateOptions: {
            shouldDehydrateQuery: query => {
              // Only persist successful queries
              return query.state.status === 'success';
            },
          },
        }}
      >
        <NavigationContainer linking={linking}>
          <AppContent />
        </NavigationContainer>
      </PersistQueryClientProvider>
    </ErrorBoundary>
  );
}
